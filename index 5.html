<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>借據簽署器</title>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, canvas, button { display: block; margin: 10px 0; width: 100%; max-width: 400px; }
    canvas { border: 1px solid #ccc; }
    #download-link { display: none; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>借據簽署器</h1>

  <!-- 客服填寫區 -->
  <section>
    <h3>客服填寫：金額資訊</h3>
    <input type="text" id="amount_text" placeholder="借款金額（中文，例如：伍萬元整）">
    <input type="text" id="amount_number" placeholder="借款金額（數字，例如：NT$50000）">
    <button id="generate-staff-pdf">產出 PDF 並傳給客戶</button>
  </section>

  <!-- 客戶簽署區 -->
  <section>
    <h3>客戶簽署</h3>
    <input type="file" id="uploaded-pdf" accept="application/pdf">
    <input type="text" id="name" placeholder="姓名">
    <input type="text" id="idnumber" placeholder="身分證號碼">
    <input type="text" id="address" placeholder="住址">
    <input type="date" id="date">
    <label>簽名：</label>
    <canvas id="signature-pad" width="300" height="100"></canvas>
    <button id="clear">清除簽名</button>
    <button id="generate-client-pdf">產出最終 PDF 並回傳</button>
  </section>

  <a id="download-link">📥 下載 PDF</a>

  <script>
    // 客服生成 PDF
    document.getElementById('generate-staff-pdf').onclick = async () => {
      const text = document.getElementById('amount_text').value;
      const number = document.getElementById('amount_number').value;
      if (!text || !number) return alert('請輸入完整金額');

      const pdfDoc = await PDFLib.PDFDocument.create();
      const page = pdfDoc.addPage([595, 842]);
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      page.drawText('借據', { x: 260, y: 780, size: 18, font });
      page.drawText(`一、茲借款金額新台幣：${text}`, { x: 50, y: 720, size: 12, font });
      page.drawText(`一、茲借款金額新台幣：${number}`, { x: 50, y: 700, size: 12, font });
      page.drawText(`二、該款項當已親收足訖無訛。`, { x: 50, y: 680, size: 12, font });
      page.drawText(`三、到期借款人即將借款本金及利息以及應付之一切款項一併清償絕不拖延。`, { x: 50, y: 660, size: 12, font });
      page.drawText(`四、保證人願負連帶清償責任及拋棄先訴抗辯權。`, { x: 50, y: 640, size: 12, font });
      page.drawText(`五、本人明確知悉本借款為雙方合意訂定，並非急迫輕率無經驗，或受到任何暴。`, { x: 50, y: 620, size: 12, font });
      page.drawText(`六、唯恐說無憑 特立此書`, { x: 50, y: 600, size: 12, font });

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const urlBlob = URL.createObjectURL(blob);
      const link = document.getElementById("download-link");
      link.href = urlBlob;
      link.download = `借據_客服填寫.pdf`;
      link.style.display = 'block';
      link.innerText = '📥 下載給客戶用 PDF';
    };

    const signaturePad = new SignaturePad(document.getElementById("signature-pad"));
    document.getElementById("clear").onclick = () => signaturePad.clear();

    // 客戶簽署後嵌入 PDF
    document.getElementById("generate-client-pdf").onclick = async () => {
      const file = document.getElementById('uploaded-pdf').files[0];
      if (!file || signaturePad.isEmpty()) return alert('請上傳 PDF 並完成簽名');

      const name = document.getElementById('name').value;
      const id = document.getElementById('idnumber').value;
      const address = document.getElementById('address').value;
      const date = document.getElementById('date').value;
      if (!name || !id || !address || !date) return alert('請填寫所有欄位');

      const arrayBuffer = await file.arrayBuffer();
      const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
      const page = pdfDoc.getPages()[0];
      const pngImage = await pdfDoc.embedPng(signaturePad.toDataURL());
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      page.drawText(`姓名：${name}`, { x: 50, y: 350, size: 12, font });
      page.drawText(`身分證號碼：${id}`, { x: 50, y: 330, size: 12, font });
      page.drawText(`住址：${address}`, { x: 50, y: 310, size: 12, font });
      page.drawText(`日期：${date}`, { x: 50, y: 290, size: 12, font });
      page.drawImage(pngImage, { x: 300, y: 320, width: 150, height: 50 });

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const urlBlob = URL.createObjectURL(blob);
      const link = document.getElementById("download-link");
      link.href = urlBlob;
      link.download = `借據_已簽署.pdf`;
      link.style.display = 'block';
      link.innerText = '📥 下載簽署完成檔案後傳回 LINE';
    };
  </script>
</body>
</html>
